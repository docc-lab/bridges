# Bridges Project

This repository contains tools for trace reconstruction and analysis, specifically designed to reconstruct traces with data loss using ancestry data stored within span objects.

## Jaeger Trace Loader

The `jaeger_trace_loader.go` tool provides comprehensive functionality to load, analyze, and simulate data loss in traces from a Jaeger backend deployed in Kubernetes.

### Features

#### Core Functionality
- **Trace Loading**: Fetches traces from Jaeger backend via REST API
- **Service Discovery**: Automatically discovers available services
- **Bloom Filter Optimization**: Efficient trace ID lookups using bloom filters
- **Trace Caching**: Reduces redundant API calls with intelligent caching
- **Deduplication**: Removes duplicate traces across services

#### Data Loss Detection
- **Parent-Child Relationship Analysis**: Detects missing parent span references
- **CHILD_OF Reference Validation**: Checks References array for proper parent relationships
- **Orphan Span Identification**: Finds spans that reference non-existent parents
- **Severity Classification**: Categorizes data loss as low/medium/high based on affected span percentage
- **Comprehensive Reporting**: Detailed analysis of missing span IDs and orphaned spans

#### Data Loss Simulation
- **Smart Span Removal**: Only removes non-root, non-leaf spans (middle nodes)
- **Realistic Simulation**: Creates actual data loss scenarios by removing critical hierarchy nodes
- **Configurable Loss Percentages**: Test different levels of data loss (10%, 20%, 30%, 50%)
- **Automatic Detection**: Simulated traces are automatically analyzed for data loss

### Usage

```bash
cd /users/dhuye/bridges
go run jaeger_trace_loader.go
```

### Configuration

The loader connects to Jaeger using the service name `jaeger-ctr:16686` (based on Kubernetes service configuration). It loads up to 10 traces per service by default.

### Output

The tool provides:
- **Service Discovery**: List of available services and trace counts
- **Trace Analysis**: Detailed span hierarchy and parent-child relationships
- **Data Loss Detection**: Comprehensive analysis of missing parent references
- **Simulation Results**: Data loss simulation with different loss percentages
- **Statistics**: Bloom filter performance and cache metrics

### Data Loss Detection Algorithm

1. **Span ID Mapping**: Creates a map of all available span IDs in the trace
2. **Reference Validation**: Checks each span's CHILD_OF references against available span IDs
3. **Missing Parent Detection**: Identifies spans that reference non-existent parent SpanIDs
4. **Orphan Classification**: Marks spans with missing parents as orphaned
5. **Severity Assessment**: Calculates loss severity based on percentage of affected spans

### Data Loss Simulation Algorithm

1. **Span Classification**: Identifies root spans (no parents) and leaf spans (no children)
2. **Eligible Span Selection**: Only selects middle nodes (spans with both parents and children)
3. **Smart Removal**: Randomly removes selected middle nodes to create realistic data loss
4. **Automatic Analysis**: Processes simulated traces to detect and measure data loss

### Example Output

```
=== PROCESSING TRACES ===
DEBUG - Trace fa58f1768b624f421c0e144e445b3aa4: Analyzing 23 spans
DEBUG - *** DATA LOSS DETECTED *** Span 7eba1cb55a104eb8 references missing parent f83572585c20cd25 (CHILD_OF)
Data loss result: hasLoss=true, missing=[f83572585c20cd25], orphans=[7eba1cb55a104eb8], severity=low

=== TESTING DATA LOSS SIMULATION ===
--- Simulating 20% data loss ---
SIMULATION - Removed 4 non-root/non-leaf spans (20.0% of eligible) from trace fa58f1768b624f421c0e144e445b3aa4
Data loss detected: true
Missing span IDs: [b0ec4e7a843708e6 0817aa93b680f5f3 81945906629896a2]
Orphan spans: [9d558256cd7ffb0a fa9efd55a8f31a90 609c238a1f8e89d8]
Loss severity: low
```

### Dependencies

- Go 1.25.2+
- `github.com/bits-and-blooms/bloom` for efficient trace lookups

### Jaeger Backend Configuration

The loader expects Jaeger to be deployed with the following service configuration:
- **Service Name**: `jaeger-ctr`
- **API Port**: `16686`
- **OTLP Port**: `4317`
- **Thrift Port**: `14268`

This matches the configuration generated by the blueprint-docc-mod project in `examples/sockshop/build/k8s/`.

### API Reference

#### Core Methods
- `LoadTraces(service, limit)` - Load traces from a specific service
- `GetServices()` - Discover available services
- `DetectDataLoss(trace)` - Analyze trace for data loss
- `SimulateDataLoss(trace, percentage)` - Create data loss simulation

#### Data Structures
- `JaegerTrace` - Complete trace with spans and metadata
- `DataLossInfo` - Data loss analysis results
- `ProcessedTrace` - Trace with analysis results
- `BaggageInfo` - Extracted baggage information (placeholder for future implementation)